---
title: "Team Performance Monitoring"
output:
  pdf_document: default
  html_notebook: default
  html_document:
    df_print: paged
---

```{r setup, message = FALSE, echo = FALSE}
library(tidyverse)
library(lubridate)
library(Rblpapi)
library(tidymas)
library(knitr)
blpConnect()
opts_chunk$set(echo=FALSE, warning = FALSE, message = FALSE)

start_date <- as.Date("2018-01-01")
end_date <- as.Date("2018-12-31")
curr <- "SGD"

####### Suggestions
# Additional trading metrics: e.g Max drawdown, sortino ratio

```

```{r, message = FALSE}
### ISSUES: NOT DOWNLOADING OLD TICKERS
### ALSO AGGREGATION BY OWNERS SEEM TO BE OFF DUE TO LACK OF CONTINUATION OF SERIES

devtools::load_all(".")

alpha <- build_alpha(file.path("..", "data2", "trademaster_full.csv"), start_date = start_date, end_date = end_date)

alpha2 <- build_alpha2(file.path("..", "data2", "trademaster.csv"), start_date = start_date, end_date = end_date)

pnl_futures <- get_trade_return_futures(alpha2, curr)

pnl_futures <- get_trade_return_futures(alpha$actual, alpha$trades, curr) %>%
  mutate(asset_class = "Futures")
pnl_bonds <- get_trade_return_bonds(alpha$actual, alpha$trades, curr) %>%
  mutate(asset_class = "Bonds")

pnl <- bind_rows(pnl_futures, pnl_bonds) %>%
  filter(pnl_type != "fx_pnl") %>%
  group_by(strategy, portfolio, owner, date, pnl_type) %>%
  summarise(pnl = sum(pnl, na.rm = T),
            cum_pnl = sum(cum_pnl, na.rm = T)) %>%
  ungroup

date_limits <- alpha$actual %>% filter(size != 0) %>%
  group_by(strategy) %>%
  summarise(min_date = min(date), max_date = max(date))
```

Report period: `r start_date` to `r end_date`

Currency: `r curr`

# Trading statistics

```{r display_statistics}
start_nav <- 9e6

daily_pnl <- pnl %>% 
  group_by(date) %>% 
  summarise(pnl = sum(pnl)) %>%
  ungroup %>%
  mutate(cum_pnl = cumsum(pnl),
         mv = start_nav + cum_pnl,
         ret = mv / dplyr::lag(mv) - 1) 

active_pnl <- daily_pnl %>% filter(pnl != 0)

sharpe <- mean(daily_pnl$ret, na.rm = TRUE) * 250 / (sd(daily_pnl$ret, na.rm = TRUE) * sqrt(250))
active_sharpe <- mean(active_pnl$ret, na.rm = TRUE) * 250 / (sd(active_pnl$ret, na.rm = TRUE) * sqrt(250))

avg_win <- mean(filter(daily_pnl, pnl > 0)$pnl)
avg_loss <- mean(filter(daily_pnl, pnl < 0)$pnl)
avg_winloss <- abs(avg_win/avg_loss)

max_win <- max(daily_pnl$pnl, na.rm = T)
max_loss <- abs(min(daily_pnl$pnl, na.rm = T))
max_winloss <- abs(max_win/max_loss)

win_rate_all <- mean(daily_pnl$pnl > 0)
win_rate_active <- mean(filter(daily_pnl, pnl != 0)$pnl > 0)

active_days <- nrow(active_pnl)
total_days <- nrow(daily_pnl)

total_pnl <- daily_pnl$cum_pnl %>% tail(1)
```

Avg Win/Loss: `r scales::number(avg_win, accuracy = 1, big.mark = ",")` / `r scales::number(abs(avg_loss), accuracy = 1, big.mark = ",")` = `r scales::number(avg_winloss, accuracy = 0.01)`

Max Win/Loss: `r scales::number(max_win, accuracy = 1, big.mark = ",")` / `r scales::number(abs(max_loss), accuracy = 1, big.mark = ",")` = `r scales::number(max_winloss, accuracy = 0.01)`

Win rate, all days: `r scales::percent(win_rate_all)`

Win rate, active days only: `r scales::percent(win_rate_active)`

Active days: `r active_days` / `r total_days` = `r scales::percent(active_days / total_days)`

Sharpe ratio (active days only): `r scales::number(sharpe, accuracy = 0.01)` (`r scales::number(active_sharpe, accuracy = 0.01)`)

Total pnl: `r scales::number(total_pnl, accuracy = 1, big.mark = ",")`

# Strategies

```{r}
strat_status <- alpha$actual %>% 
  group_by(strategy, portfolio, owner) %>% 
  summarise(max_date = max(date)) %>% 
  ungroup %>% 
  mutate(status = ifelse(max_date != end_date, "CLOSED", "OPEN")) %>% 
  select(portfolio, owner, strategy, status)

pnl %>% 
  filter(owner %in% c("ES", "BC")) %>%
  left_join(strat_status, by = c("strategy", "portfolio", "owner")) %>%
  group_by(.data$strategy, .data$portfolio, .data$owner, .data$status) %>%
  summarise(pnl = sum(.data$pnl)) %>%
  ungroup %>%
  arrange(desc(status), desc(pnl)) %>%
  mutate(pnl = scales::number(pnl, big.mark = ",", accuracy = 1)) %>%
  kable(align = "llr")
```


```{r}
pnl %>% 
  filter(pnl_type != "fx_pnl") %>%
  group_by(date, owner) %>% 
  summarise(pnl = sum(pnl)) %>%
  group_by(owner) %>%
  mutate(cum_pnl = cumsum(pnl)) %>%
  ggplot(aes(x = date, y = cum_pnl / 1e6)) +
  geom_area(aes(fill = owner)) +
      stat_summary(fun.y = sum, geom = "line", size = 1) +
  labs(title = "Team + PA, excluding FX")

pnl %>% 
    filter(pnl_type != "fx_pnl") %>%
  group_by(date, owner) %>% 
  summarise(pnl = sum(pnl)) %>%
  group_by(owner) %>%
  filter(! owner %in% c("ES", "BC", "RX")) %>%
  mutate(cum_pnl = cumsum(pnl)) %>%
  ggplot(aes(x = date, y = cum_pnl / 1e6)) +
  geom_area(aes(fill = owner)) +
      stat_summary(fun.y = sum, geom = "line", size = 1) +
  labs(title = "PA only, excluding FX")
  

pnl %>% 
  filter(pnl_type != "fx_pnl") %>%
  group_by(date, pnl_type) %>% 
  summarise(pnl = sum(pnl)) %>%
  group_by(pnl_type) %>%
  mutate(cum_pnl = cumsum(pnl)) %>%
  ggplot(aes(x = date, y = cum_pnl / 1e6)) +
  geom_area(aes(fill = pnl_type)) +
      stat_summary(fun.y = sum, geom = "line", size = 1) +
  labs(title = "Team + PA, excluding FX")
  
# pnl_owner %>% group_by(strategy, owner) %>%
#   summarise(pnl = sum(pnl)) %>%
#   filter(pnl != 0) %>%
#   arrange(desc(abs(pnl))) %>%
#   mutate(pnl = scales::number(pnl, big.mark = ","))
  

```

# PnL profile

```{r}
  # Plot by strategy
pnl %>%
    filter(pnl_type != "fx_pnl", owner %in% c("ES")) %>%
    mutate(strategy_clean =trimws(str_extract(strategy, "^.*(?= *[-\\[\\(])")),
           strategy = ifelse(is.na(strategy_clean), strategy, strategy_clean)) %>%
    mutate(strategy = str_replace(strategy, coll("ultra-long", TRUE), "ultra"),
strategy = str_replace(strategy, coll("long", TRUE), "L"),
strategy = str_replace(strategy, coll("steepener", TRUE), "stpn")) %>%
    group_by(strategy, owner, date) %>%
    summarise(cum_pnl = sum(.data$cum_pnl, na.rm =T)) %>%
    ungroup() %>%
    ggplot(aes(x = date, y= cum_pnl/1e6)) +
  facet_wrap(~as.factor(owner), ncol = 1) +
    geom_area(aes(fill = strategy)) +
    stat_summary(fun.y = sum, geom = "line", size = 1) +
    theme(axis.title.x = element_blank(), legend.position = "bottom") +
    labs(title = "By strategy, excluding FX")

pnl %>%
    filter(pnl_type != "fx_pnl", owner %in% c("BC")) %>%
    mutate(strategy_clean =trimws(str_extract(strategy, "^.*(?= *[-\\[\\(])")),
           strategy = ifelse(is.na(strategy_clean), strategy, strategy_clean)) %>%
    group_by(strategy, owner, date) %>%
    summarise(cum_pnl = sum(.data$cum_pnl, na.rm =T)) %>%
    ungroup() %>%
    ggplot(aes(x = date, y= cum_pnl/1e6)) +
  facet_wrap(~as.factor(owner), ncol = 1) +
    geom_area(aes(fill = strategy)) +
    stat_summary(fun.y = sum, geom = "line", size = 1) +
    theme(axis.title.x = element_blank(), legend.position = "bottom") +
    labs(title = "By strategy, excluding FX")


```

# Strategies by type 

```{r}
pnl_w_type <- pnl %>% 
  left_join(alpha$summary %>% group_by(strategy, type) %>% summarise %>% ungroup,
            by = c("strategy"))

pnl_w_type %>%
    filter(pnl_type != "fx_pnl") %>%
    mutate(strategy = str_extract(strategy, "^.*(?=:::)")) %>%
    group_by(type, date) %>%
    summarise(cum_pnl = sum(.data$cum_pnl, na.rm =T)) %>%
    ungroup() %>%
    ggplot(aes(x = date, y= cum_pnl/1e6)) +
    geom_area(aes(fill = type)) +
    stat_summary(fun.y = sum, geom = "line", size = 1) +
    theme(axis.title.x = element_blank(), legend.position = "bottom") +
    labs(title = "By type, excluding FX")

```

# Pnl of strategies

```{r, fig.height = 11, fig.width = 7}
  top_es_9 <- pnl %>% 
      filter(owner == "ES") %>%
    group_by(strategy, date) %>%
    summarise(cum_pnl = sum(cum_pnl)) %>%
    ungroup %>%
    group_by(strategy) %>%
  summarise(max_pnl = max(abs(cum_pnl))) %>%
  arrange(desc(max_pnl)) %>%
  top_n(9) %>%
  .$strategy
  
    

  # Cumulative Pnl by strategy and type
  pnl %>%
    filter(owner == "ES", strategy %in% top_es_9) %>%
    left_join(date_limits, by = "strategy") %>%
        mutate(strategy = factor(strategy, levels = top_es_9)) %>%
    filter(date < max_date, date > min_date) %>%
    ggplot(aes(x = date, y = cum_pnl / 1e3)) +
    geom_area(aes(fill = pnl_type)) +
    stat_summary(fun.y = sum, geom = "line", size = 0.5) +
    facet_wrap(~strategy, ncol = 3, scales = "free_x") +
    theme(legend.position = "bottom") +
    labs(title = "Cumulative pnl")

```

# ROR

```{r}
calc_ror <- function(portfolio, trades, target_port, curr) {
  
  strat_by_port <- trades %>% 
  select(strategy, portfolio, owner) %>%
  unique()
  # G-EUR
pnl_futures <- get_trade_return_futures(portfolio, trades, curr) %>%
  mutate(asset_class = "Futures")
pnl_bonds <- get_trade_return_bonds(portfolio, trades, curr) %>%
  mutate(asset_class = "Bonds")

pnl <- bind_rows(pnl_futures, pnl_bonds) %>%
  filter(pnl_type != "fx_pnl") %>%
  group_by(strategy, date, pnl_type) %>%
  summarise(pnl = sum(pnl, na.rm = T),
            cum_pnl = sum(cum_pnl, na.rm = T)) %>%
  ungroup

pnl_port <- pnl %>% 
  left_join(strat_by_port, by = "strategy") %>%
  filter(portfolio == target_port) %>%
  filter(pnl_type != "fx_pnl") %>%
  mutate(month_year = format(date, "%Y-%m")) %>%
  group_by(strategy, month_year) %>%
  summarise(pnl = sum(pnl)) %>%
  filter(pnl != 0) %>%
  spread(month_year, pnl)

bind_rows(pnl_port,
      as.tibble(
        cbind(data.frame(strategy = "TOTAL", stringsAsFactors = FALSE), 
              t(data.frame(total = colSums(pnl_port[,-1], na.rm = TRUE)))))) %>%
  ungroup %>%
  mutate(TOTAL = rowSums(select(., -strategy), na.rm = T))
}

geur_ror <- calc_ror(alpha$actual, alpha$trades, "G-EUR", "EUR")
ieur_ror <- calc_ror(alpha$actual, alpha$trades, "I-EUR", "EUR")
ggbp_ror <- calc_ror(alpha$actual, alpha$trades, "G-GBP", "GBP")
igbp_ror <- calc_ror(alpha$actual, alpha$trades, "I-GBP", "GBP")

strat_by_port <- alpha$trades %>% 
  select(strategy, portfolio, owner) %>%
  unique()

# G-EUR
pnl_futures <- get_trade_return_futures(alpha$actual, alpha$trades, "EUR") %>%
  mutate(asset_class = "Futures")
pnl_bonds <- get_trade_return_bonds(alpha$actual, alpha$trades, "EUR") %>%
  mutate(asset_class = "Bonds")

pnl_eur <- bind_rows(pnl_futures, pnl_bonds) %>%
  filter(pnl_type != "fx_pnl") %>%
  group_by(strategy, date, pnl_type) %>%
  summarise(pnl = sum(pnl, na.rm = T),
            cum_pnl = sum(cum_pnl, na.rm = T)) %>%
  ungroup
  
pnl_eur_port <- pnl_eur %>% 
  left_join(strat_by_port, by = "strategy") %>%
  filter(portfolio == "G-EUR") %>%
  filter(pnl_type != "fx_pnl") %>%
  filter(date <= as.Date("2018-12-31"), date >= as.Date("2018-12-01")) %>%
  group_by(strategy) %>%
  summarise(pnl = sum(pnl)) %>%
  filter(pnl != 0)

# G-GBP
pnl_futures <- get_trade_return_futures(alpha$actual, alpha$trades, "GBP") %>%
  mutate(asset_class = "Futures")
pnl_bonds <- get_trade_return_bonds(alpha$actual, alpha$trades, "GBP") %>%
  mutate(asset_class = "Bonds")

pnl_gbp <- bind_rows(pnl_futures, pnl_bonds) %>%
  filter(pnl_type != "fx_pnl") %>%
  group_by(strategy, date, pnl_type) %>%
  summarise(pnl = sum(pnl, na.rm = T),
            cum_pnl = sum(cum_pnl, na.rm = T)) %>%
  ungroup
  
pnl_gbp_port <- pnl_gbp %>% 
  left_join(strat_by_port, by = "strategy") %>%
  filter(portfolio == "G-GBP") %>%
  filter(pnl_type != "fx_pnl") %>%
  filter(date <= as.Date("2018-12-31"), date >= as.Date("2018-12-01")) %>%
  group_by(strategy) %>%
  summarise(pnl = sum(pnl)) %>%
  filter(pnl != 0)

kable(geur_ror)
  

# Build ROR for every portfolio over rolling 12 months

```
